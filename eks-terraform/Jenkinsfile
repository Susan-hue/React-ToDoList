pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'SKIP_INFRA',
            defaultValue: true,
            description: 'Skip EKS cluster creation if it already exists'
        )
    }

    environment {
        FRONTEND_IMAGE = 'peterukpabi4/eks-react-todo'
        BACKEND_IMAGE  = 'peterukpabi4/eks-react-todo-backend'
        TAG = "${env.BUILD_NUMBER}"

        AWS_CREDENTIALS = credentials('aws-credentials')
        AWS_ACCESS_KEY_ID = "${env.AWS_CREDENTIALS_USR}"
        AWS_SECRET_ACCESS_KEY = "${env.AWS_CREDENTIALS_PSW}"
        AWS_DEFAULT_REGION = 'us-east-1'

        EKS_CLUSTER_NAME = 'dive-app-cluster'
        EKS_REGION = 'us-east-1'

        FRONTEND_APP = 'react-todo-frontend'
        BACKEND_APP  = 'react-todo-backend'
        MONGO_APP    = 'mongo'
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Terraform - Create/Update EKS Cluster') {
            when { expression { params.SKIP_INFRA == false } }
            steps {
                dir('eks-terraform') {
                    sh '''
                    terraform init
                    terraform plan -out=tfplan
                    terraform apply -auto-approve tfplan
                    '''
                }
            }
        }

       stage('Configure AWS and EKS') {
    steps {
        withCredentials([usernamePassword(
            credentialsId: 'aws-credentials',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
        )]) {
            sh '''
            aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
            aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
            aws configure set region us-east-1

            aws sts get-caller-identity

            aws eks update-kubeconfig --region us-east-1 --name dive-app-cluster

            kubectl cluster-info
            kubectl get nodes
            '''
        }
    }
}


        stage('Docker Login') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                    echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                dir('dive-react-app') {
                    sh "docker build -t ${FRONTEND_IMAGE}:${TAG} ."
                }
                dir('backend') {
                    sh "docker build -t ${BACKEND_IMAGE}:${TAG} ."
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                sh """
                docker push ${FRONTEND_IMAGE}:${TAG}
                docker push ${BACKEND_IMAGE}:${TAG}
                """
            }
        }

        stage('Deploy Application to EKS') {
            steps {
                dir('eks-terraform') {
                    sh """
                    sed -i 's|image: peterukpabi4/eks-react-todo:v1|image:${FRONTEND_IMAGE}:${TAG}|g' frontend.yaml
                    sed -i 's|image: peterukpabi4/eks-react-todo-backend|image:${BACKEND_IMAGE}:${TAG}|g' backend.yaml

                    kubectl apply -f configmap.yaml
                    kubectl apply -f secret.yaml
                    kubectl apply -f mongo-deployment.yaml
                    kubectl apply -f mongo-service.yaml
                    kubectl apply -f frontend.yaml
                    kubectl apply -f backend.yaml

                    kubectl rollout status deployment/${FRONTEND_APP} --timeout=300s
                    kubectl rollout status deployment/${BACKEND_APP} --timeout=300s
                    kubectl rollout status deployment/${MONGO_APP} --timeout=300s
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ Pipeline completed successfully!'
            sh """
            kubectl get pods
            kubectl get svc
            """
        }
        failure {
            echo '❌ Pipeline failed!'
        }
        always {
            sh 'docker logout'
            archiveArtifacts artifacts: '**/*.yaml', allowEmptyArchive: true
        }
    }
}
