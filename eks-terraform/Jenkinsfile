pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'SKIP_INFRA',
            defaultValue: true,
            description: 'Skip EKS cluster creation if it already exists'
        )
    }

    environment {
        // Docker image details
        FRONTEND_IMAGE = 'peterukpabi4/eks-react-todo'
        BACKEND_IMAGE = 'peterukpabi4/eks-react-todo-backend'
        TAG = "${env.BUILD_NUMBER}"

        // AWS credentials (from Jenkins "Username with password" credential)
        AWS_CREDENTIALS = credentials('aws-credentials')
        AWS_ACCESS_KEY_ID = "${env.AWS_CREDENTIALS_USR}"
        AWS_SECRET_ACCESS_KEY = "${env.AWS_CREDENTIALS_PSW}"
        AWS_DEFAULT_REGION = 'us-east-1'

        // EKS and cluster info
        EKS_CLUSTER_NAME = 'dive-app-cluster'
        EKS_REGION = 'us-east-1'

        // App names (optional)
        FRONTEND_APP = 'react-todo-frontend'
        BACKEND_APP = 'react-todo-backend'
        MONGO_APP = 'mongo'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

       stage('Terraform - Create/Update EKS Cluster') {
    when { expression { params.SKIP_INFRA == false } }
    steps {
        withCredentials([usernamePassword(
            credentialsId: 'aws-credentials',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
        )]) {
            dir('eks-terraform') {
                sh '''
                export AWS_DEFAULT_REGION=us-east-1

                terraform init
                terraform validate
                terraform plan -out=tfplan
                terraform apply -auto-approve tfplan
                '''
            }
        }
    }
}


        stage('Configure AWS and EKS') {
            steps {
                sh """
                aws configure set aws_access_key_id ${AWS_ACCESS_KEY_ID}
                aws configure set aws_secret_access_key ${AWS_SECRET_ACCESS_KEY}
                aws configure set region ${AWS_DEFAULT_REGION}

                aws eks update-kubeconfig --region ${EKS_REGION} --name ${EKS_CLUSTER_NAME}

                kubectl cluster-info
                kubectl get nodes
                """
            }
        }

        stage('Build Docker Images') {
            steps {
                dir('dive-react-app') {
                    sh "docker build -t ${FRONTEND_IMAGE}:${TAG} ."
                }
                dir('backend') {
                    sh "docker build -t ${BACKEND_IMAGE}:${TAG} ."
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                sh """
                docker push ${FRONTEND_IMAGE}:${TAG}
                docker push ${BACKEND_IMAGE}:${TAG}
                """
            }
        }

        stage('Deploy Application to EKS') {
            steps {
                dir('eks-terraform') { 
                    sh """
                    # Replace images in the manifests with latest build tags
                    sed -i 's|image: peterukpabi4/eks-react-todo:v1|image:${FRONTEND_IMAGE}:${TAG}|g' frontend.yaml
                    sed -i 's|image: peterukpabi4/eks-react-todo-backend|image:${BACKEND_IMAGE}:${TAG}|g' backend.yaml

                    # Apply all manifests (default namespace)
                    kubectl apply -f configmap.yaml
                    kubectl apply -f secret.yaml
                    kubectl apply -f mongo-deployment.yaml
                    kubectl apply -f mongo-service.yaml
                    kubectl apply -f frontend.yaml
                    kubectl apply -f backend.yaml

                    # Wait for deployments to be ready
                    kubectl rollout status deployment/${FRONTEND_APP} --timeout=300s
                    kubectl rollout status deployment/${BACKEND_APP} --timeout=300s
                    kubectl rollout status deployment/${MONGO_APP} --timeout=300s
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ Pipeline completed successfully!'
            sh """
            kubectl get pods
            kubectl get svc
            """
        }
        failure {
            echo '❌ Pipeline failed!'
            sh """
            kubectl describe pods -l app=${FRONTEND_APP}
            kubectl describe pods -l app=${BACKEND_APP}
            kubectl logs --tail=50 -l app=${FRONTEND_APP}
            kubectl logs --tail=50 -l app=${BACKEND_APP}
            """
        }
        always {
            sh 'docker logout'
            archiveArtifacts artifacts: '**/*.yaml', allowEmptyArchive: true
        }
    }
}

